<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dark Patterns Classifier</title>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div id="spinner" style="display: none; text-align: center; margin-top: 10px;">
    <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: auto;"></div>
</div>
<div id="div" style="overflow-y: auto; padding-bottom: 12%;"></div>
<div id="formDiv" style="position: fixed; bottom: 0; width: 100%; background-color: white; padding: 10px;">
    <form id="explanationForm" onsubmit="submitForm(event)">
        <br/>
        <textarea id="textarea" name="textarea"
                  placeholder="Please input your privacy policies here for classification. Put each policy on a separate line."
                  style="width: 85%; box-sizing: border-box;" required></textarea>
        <input type="submit" value="Classify Policies" style="width: 10%"/>
    </form>
</div>

<script>
    let inputText = "";
    let briefed = false;

    async function submitForm(event) {
        event.preventDefault();
        inputText = document.getElementById("textarea").value;
        document.getElementById("textarea").value = "";
        await fetchAndRead("brief");
    }

    async function fetchAndRead(mode) {
        const div = document.getElementById("div");
        const spinner = document.getElementById("spinner");

        if (briefed) {
            briefed = false;
            const button = document.getElementById("button");
            if (button) button.remove();
        }

        spinner.style.display = "block";
        div.textContent = "";

        try {
            const response = await fetch(`http://localhost:8000/${mode}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: inputText })
            });

            if (!response.ok) {
                div.textContent = "Error: Response not received from the server!";
                spinner.style.display = "none";
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let accumulatedText = "";

            async function read() {
                const { done, value } = await reader.read();
                if (done) {
                    spinner.style.display = "none";
                    if (mode === "brief" && !briefed) {
                        briefed = true;
                        createDetailedButton();
                    }
                    return;
                }

                // Decode the stream chunk and accumulate the text
                accumulatedText += decoder.decode(value, { stream: true });

                const lines = accumulatedText.split("\n\n\n");
                accumulatedText = lines.pop();
                // Process and display each policy and its explanation immediately
                for (const line of lines) {
                    if (line.trim() === "") continue;

                    try {
                        const policy = JSON.parse(line);
                        const policyElement = createElement("h3", policy.policy, true);

                        div.appendChild(policyElement);

                        const explanation = createElement("p", policy.explanation);

                        div.appendChild(explanation);
                    } catch (e) {
                        console.error("Failed to parse line", line, e);
                    }
                }

                // Continue reading from the stream
                await read();
            }

            await read();
        } catch (error) {
            div.textContent = "Error: An error occurred!";
            spinner.style.display = "none";
            console.error('Fetch error:', error);
        }
    }

    function createElement(tag, text, insertBreak = false) {
        const element = document.createElement(tag);
        element.textContent = text;
        if (insertBreak) element.appendChild(document.createElement("br"));
        return element;
    }

    function createDetailedButton() {
        const div = document.getElementById("div");
        const button = document.createElement("button");
        button.id = "button";
        button.type = "button";
        button.textContent = "Detailed Explanation";
        button.onclick = () => fetchAndRead("detailed");
        div.appendChild(button);
    }
</script>

</body>
</html>